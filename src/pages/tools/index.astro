---
import BaseLayout from '../../layouts/BaseLayout.astro';
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';
import ToolCard from '../../components/ToolCard.astro';
import TikTokView from '../../components/TikTokView.astro';
import { getCollection } from 'astro:content';

const allTools = await getCollection('tools');
const tools = allTools.sort((a, b) =>
  new Date(b.data.date_added).getTime() - new Date(a.data.date_added).getTime()
);

// Count tag frequency and split into popular (3+) and rest
const tagCounts = new Map<string, number>();
tools.forEach(t => t.data.tags.forEach(tag => {
  const lower = tag.toLowerCase();
  tagCounts.set(lower, (tagCounts.get(lower) || 0) + 1);
}));
const popularTags = [...tagCounts.entries()]
  .filter(([, count]) => count >= 3)
  .sort((a, b) => b[1] - a[1])
  .map(([tag]) => tag);
const moreTags = [...tagCounts.entries()]
  .filter(([, count]) => count < 3)
  .sort((a, b) => b[1] - a[1] || a[0].localeCompare(b[0]))
  .map(([tag]) => tag);

// Count author frequency and get author details
const authorData = new Map<string, { name: string; github: string; count: number }>();
tools.forEach(t => {
  const author = t.data.author;
  if (authorData.has(author)) {
    authorData.get(author)!.count++;
  } else {
    authorData.set(author, {
      name: author,
      github: t.data.author_github,
      count: 1
    });
  }
});
const sortedAuthors = [...authorData.values()]
  .sort((a, b) => b.count - a.count || a.name.localeCompare(b.name));
---

<BaseLayout title="Browse Tools ‚Äî Tiny Tool Town üèòÔ∏è" description="Explore all the tiny, delightful, open source tools in Tiny Tool Town.">
  <Header />

  <main id="main" class="container">
    <section class="browse-header">
      <h1>Browse the Town üèòÔ∏è</h1>
      <p class="browse-subtitle">{tools.length} tiny tools and counting</p>
    </section>

    <!-- Search & Filter -->
    <div class="filter-bar">
      <div class="search-box">
        <svg class="search-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
        <label for="search" class="visually-hidden">Search tools</label>
        <input
          type="text"
          id="search"
          placeholder="Search tools..."
          class="search-input"
          autocomplete="off"
        />
      </div>
      
      <!-- Author Filter -->
      <div class="filter-section">
        <h3 class="filter-label">Filter by Author</h3>
        <div class="authors-filter" id="authors-filter">
          <button class="author-btn active" data-author="all">All Authors</button>
          {sortedAuthors.map(author => (
            <button class="author-btn" data-author={author.name.toLowerCase()}>
              <img
                src={`https://github.com/${author.github}.png?size=20`}
                alt={author.name}
                class="author-filter-avatar"
                loading="lazy"
              />
              <span>{author.name}</span>
              <span class="author-count">{author.count}</span>
            </button>
          ))}
        </div>
      </div>

      <!-- Tag Filter -->
      <div class="filter-section">
        <h3 class="filter-label">Filter by Tag</h3>
        <div class="tags-filter" id="tags-filter">
        <button class="tag-btn active" data-tag="all">All</button>
        {popularTags.map(tag => (
          <button class="tag-btn" data-tag={tag}>{tag} <span class="tag-count">{tagCounts.get(tag)}</span></button>
        ))}
        {moreTags.length > 0 && (
          <button class="tag-btn more-tags-toggle" id="more-tags-toggle">More ‚ñæ</button>
        )}
        <div class="more-tags" id="more-tags" style="display: none;">
          {moreTags.map(tag => (
            <button class="tag-btn" data-tag={tag}>{tag}</button>
          ))}
        </div>
      </div>
      </div>
    </div>

    <!-- Tool Grid -->
    <div class="tool-grid" id="tool-grid">
      {tools.map(tool => (
        <div class="tool-item"
          data-name={tool.data.name.toLowerCase()}
          data-tagline={tool.data.tagline.toLowerCase()}
          data-tags={tool.data.tags.map(t => t.toLowerCase()).join(',')}
          data-author={tool.data.author.toLowerCase()}
        >
          <ToolCard
            name={tool.data.name}
            slug={tool.id.replace(/\.md$/, '')}
            tagline={tool.data.tagline}
            author={tool.data.author}
            author_github={tool.data.author_github}
            tags={tool.data.tags}
            language={tool.data.language}
            featured={tool.data.featured}
            thumbnail={tool.data.thumbnail}
          />
        </div>
      ))}
    </div>

    <div id="no-results" class="no-results" style="display: none;" aria-live="polite" aria-atomic="true">
      <p>üîç No tools found. Try a different search?</p>
    </div>
  </main>

  <!-- Floating button to launch Shorts mode -->
  <button id="launch-vertical-view-tools" class="floating-shorts-btn" aria-label="Open shorts view">
    üì± Shorts
  </button>

  <TikTokView tools={tools} />

  <Footer />
</BaseLayout>

<script>
  const search = document.getElementById('search') as HTMLInputElement;
  const grid = document.getElementById('tool-grid')!;
  const items = grid.querySelectorAll('.tool-item');
  const tagButtons = document.querySelectorAll('.tag-btn:not(.more-tags-toggle)');
  const authorButtons = document.querySelectorAll('.author-btn');
  const noResults = document.getElementById('no-results')!;
  const moreToggle = document.getElementById('more-tags-toggle');
  const moreTags = document.getElementById('more-tags');

  let activeTag = 'all';
  let activeAuthor = 'all';

  // "More ‚ñæ" expander
  if (moreToggle && moreTags) {
    moreToggle.addEventListener('click', () => {
      const visible = moreTags.style.display !== 'none';
      moreTags.style.display = visible ? 'none' : 'contents';
      moreToggle.textContent = visible ? 'More ‚ñæ' : 'Less ‚ñ¥';
    });
  }

  function filterTools() {
    const query = search.value.toLowerCase().trim();
    let visible = 0;

    items.forEach(item => {
      const el = item as HTMLElement;
      const name = el.dataset.name || '';
      const tagline = el.dataset.tagline || '';
      const tags = (el.dataset.tags || '').toLowerCase();
      const author = el.dataset.author || '';

      const matchesSearch = !query || name.includes(query) || tagline.includes(query) || tags.includes(query) || author.includes(query);
      const matchesTag = activeTag === 'all' || tags.split(',').includes(activeTag);
      const matchesAuthor = activeAuthor === 'all' || author === activeAuthor;

      if (matchesSearch && matchesTag && matchesAuthor) {
        el.style.display = '';
        visible++;
      } else {
        el.style.display = 'none';
      }
    });

    noResults.style.display = visible === 0 ? 'block' : 'none';
  }

  search.addEventListener('input', filterTools);

  // Handle tag clicks (both popular and expanded)
  document.getElementById('tags-filter')!.addEventListener('click', (e) => {
    const btn = (e.target as HTMLElement).closest('.tag-btn:not(.more-tags-toggle)') as HTMLElement;
    if (!btn || !btn.dataset.tag) return;
    document.querySelectorAll('.tag-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    activeTag = btn.dataset.tag;
    filterTools();
  });

  // Handle author clicks
  document.getElementById('authors-filter')!.addEventListener('click', (e) => {
    const btn = (e.target as HTMLElement).closest('.author-btn') as HTMLElement;
    if (!btn || !btn.dataset.author) return;
    document.querySelectorAll('.author-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    activeAuthor = btn.dataset.author;
    filterTools();
  });
</script>

<style>
  .browse-header {
    padding: 2.5rem 0 1.5rem;
  }

  .browse-header h1 {
    font-size: 2rem;
    font-weight: 900;
  }

  .browse-subtitle {
    color: var(--color-text);
    opacity: 0.7;
    margin-top: 0.25rem;
  }

  .filter-bar {
    margin-bottom: 2rem;
  }

  .filter-section {
    margin-bottom: 1.5rem;
  }

  .filter-section:last-child {
    margin-bottom: 0;
  }

  .filter-label {
    font-size: 0.9rem;
    font-weight: 600;
    color: var(--color-text);
    margin-bottom: 0.75rem;
    opacity: 0.8;
  }

  .search-box {
    position: relative;
    margin-bottom: 1.5rem;
  }

  .search-icon {
    position: absolute;
    left: 1rem;
    top: 50%;
    transform: translateY(-50%);
    color: var(--color-text-muted);
    pointer-events: none;
  }

  .search-input {
    width: 100%;
    padding: 0.85rem 1rem 0.85rem 2.75rem;
    background: var(--color-bg-card);
    border: 1px solid var(--color-border);
    border-radius: var(--radius);
    color: var(--color-text);
    font-size: 1rem;
    font-family: inherit;
    transition: border-color 0.2s;
  }

  .search-input::placeholder {
    color: var(--color-text-muted);
  }

  .search-input:focus {
    outline: none;
    border-color: var(--color-primary);
  }

  .authors-filter {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
  }

  .author-btn {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.4rem 0.9rem;
    background: var(--color-bg-card);
    border: 1px solid var(--color-border);
    border-radius: 50px;
    color: var(--color-text-muted);
    font-size: 0.85rem;
    font-family: inherit;
    cursor: pointer;
    transition: all 0.2s;
  }

  .author-btn:hover {
    border-color: var(--color-primary);
    color: var(--color-primary);
  }

  .author-btn.active {
    background: var(--color-primary);
    color: var(--color-bg);
    border-color: var(--color-primary);
  }

  .author-filter-avatar {
    width: 20px;
    height: 20px;
    border-radius: 50%;
    flex-shrink: 0;
  }

  .author-count {
    font-size: 0.7rem;
    opacity: 0.6;
    margin-left: 0.15rem;
  }

  .author-btn.active .author-count {
    opacity: 0.8;
  }

  .tags-filter {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
  }

  .tag-btn {
    padding: 0.4rem 0.9rem;
    background: var(--color-bg-card);
    border: 1px solid var(--color-border);
    border-radius: 50px;
    color: var(--color-text-muted);
    font-size: 0.85rem;
    font-family: inherit;
    cursor: pointer;
    transition: all 0.2s;
  }

  .tag-btn:hover {
    border-color: var(--color-primary);
    color: var(--color-primary);
  }

  .tag-btn.active {
    background: var(--color-primary);
    color: var(--color-bg);
    border-color: var(--color-primary);
  }

  .tag-count {
    font-size: 0.7rem;
    opacity: 0.6;
    margin-left: 0.15rem;
  }

  .tag-btn.active .tag-count {
    opacity: 0.8;
  }

  .more-tags-toggle {
    border-style: dashed;
    font-style: italic;
  }

  .more-tags {
    display: contents;
  }

  .tool-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 1.5rem;
  }

  .no-results {
    text-align: center;
    padding: 3rem;
    color: var(--color-text-muted);
    font-size: 1.1rem;
  }

  /* Floating Shorts Button */
  .floating-shorts-btn {
    position: fixed;
    bottom: 2rem;
    right: 2rem;
    z-index: 1000;
    background: linear-gradient(135deg, var(--color-primary), var(--color-secondary));
    color: #fff;
    border: none;
    padding: 0.875rem 1.5rem;
    border-radius: 50px;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    box-shadow: 0 8px 24px rgba(255, 137, 6, 0.35);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .floating-shorts-btn:hover {
    transform: translateY(-3px) scale(1.05);
    box-shadow: 0 12px 32px rgba(255, 137, 6, 0.5);
  }

  .floating-shorts-btn:active {
    transform: translateY(-1px) scale(1.02);
  }

  @media (max-width: 640px) {
    .floating-shorts-btn {
      bottom: 1.25rem;
      right: 1.25rem;
      padding: 0.75rem 1.25rem;
      font-size: 0.9rem;
    }
  }
</style>

<script>
  // Launch vertical shorts view when button is clicked
  const launchBtn = document.getElementById('launch-vertical-view-tools');
  if (launchBtn) {
    launchBtn.addEventListener('click', () => {
      if (typeof (window as any).launchShortsViewer === 'function') {
        (window as any).launchShortsViewer();
      }
    });
  }
</script>
